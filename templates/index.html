<!DOCTYPE html>
<html>
<head>
    <title>Local Farms</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
    /* Set a more modern font family */
    html * {
        font-family: 'Times New Roman', Times, serif; /* Classic and formal font style */
        font-weight: normal;
    }

    /* Refine the body layout */
    body {
        display: flex;
        justify-content: space-between;
        height: 100vh;
        margin: 0;
        padding: 0;
        background-color: #f4f4f4; /* Light grey background for less strain on eyes */
    }

    .section {
    border-radius: 8px; /* Optional: Rounded corners for the sections */
    background-color: white; /* Brighter background for better contrast */
    padding: 20px;
    overflow: auto;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1); /* Soft shadow for depth */
    }

 .upperLeftSection {
    position: fixed;
    left: 0;
    width: 25%;
    border: 10px ridge black; /* Plaque-like frame */
    height: 45%; /* Set height to occupy 45% of the viewport */
    background-color: rgb(222, 222, 222);
    text-align: center;
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.lowerLeftSection {
            position: fixed;
            left: 0;
            width: 25%;
            top: 50%; /* Position at 50% from the top of the viewport */
            border: 10px ridge black; /* Plaque-like frame */
            height: 45%; /* Set height to occupy 45% of the viewport */
            background-color: rgb(222, 222, 222);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
        }
        #tags-list {
            list-style-type: none;
            padding: 0; 
            margin: 0;
        }
        #tags-list li {
            word-wrap: break-word; /* Allow words to break if necessary */
        }


    .rightSection {
        position: fixed;
        right: 0;
        width: 25%;
        border: 10px ridge black; /* Plaque-like frame */
        height: 95%;
        background-color: rgb(222, 222, 222);
        text-align: center;
    }

    .middleSection {
        position: absolute;
        left: 27%;
        right: 27%;
        border: 10px ridge black; /* Plaque-like frame */
        height: 95%;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 8px; /* Rounded corners for the map */
    }

    #map {
        height: 100%; /* Adjusted height */
        width: 100%; /* Full width of the middle section */
    }
</style>

</head>
<body>
    <div class="upperLeftSection">
        <h1>Select a Farm to Display</h1>
        <select id="farmSelect" onchange="zoomToFarm()">
            <option value="">--Select a Farm--</option>
            {% for farm in farms %}
            <option value="{{ farm['id'] }}" data-lat="{{ farm.latitude }}" data-lng="{{ farm.longitude }}" data-description="{{ farm.description }}">
            {{ farm['name'] }}
            </option>
            {% endfor %}
        </select>
        </div>
    <div class="lowerLeftSection">
        <h2 style="margin:0">Available Tags</h2>
        <form id="tagselection">
            <ul id="tags-list"></ul>
            <button type="button" onclick="applyFilter()">Apply Filters</button>
        </form>
        <script>
            function fetchTags() {
                fetch('/fetch-tags')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Hittade ej fetch-tags');
                        }
                        return response.json();
                    })
                    .then(tags => {
                        const tagsList = document.getElementById('tags-list');
                        tags.forEach(tag => {
                            const li = document.createElement('li');
                            const checkbox = document.createElement('input');
                            checkbox.type = 'checkbox';
                            checkbox.name = 'tags';
                            checkbox.value = tag;
                            li.appendChild(checkbox);
                            li.appendChild(document.createTextNode(tag));
                            tagsList.appendChild(li);
                        });
                    })
                    .catch(error => {
                        console.error('Fetch not successful', error);
                    });
            }
            fetchTags(); 
    
            function applyFilter() {
                const form = document.getElementById('tagselection');
                const selectedTags = Array.from(form.elements.tags).filter(tag => tag.checked).map(tag => tag.value);
                console.log('Selected tags:', selectedTags);
                //Vet ej hur vi vill göra här, nu väntar den tills användaren klickar på apply filters och då lagrar den alla tags, vill vi göra så?
            }
        </script>
    </div>
    </div>

    <div class="middleSection">
    <div id="map"></div>
    <script>
        var map = L.map('map', {
            minZoom: 3,  // Minimum zoom level
            maxZoom: 18, // Maximum zoom level
            maxBounds: [  // Define the geographical boundaries to restrict the map panning
                [-100, -160],  // SouthWest corner of the boundary
                [150, 180]    // NorthEast corner of the boundary
            ],
            maxBoundsViscosity: 1.0  // Makes the bounds fully rigid
        }).setView([63, 15], 5.4);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data © <a href="https://openstreetmap.org">OpenStreetMap</a> contributors',
            noWrap: true
        }).addTo(map);

        var markers = {};

        {% for farm in farms %}
        markers['{{ farm['id'] }}'] = add_marker({{ farm.latitude }}, {{ farm.longitude }}, "{{ farm.name }}", "{{ farm.description }}");
        {% endfor %}

        function add_marker(latitude, longitude, name, description) {
        var marker = L.marker([latitude, longitude]).addTo(map).bindPopup("<b>" + name);

        marker.on('click', function() {
            updateInfo(name, description);
        });

        return marker;
    }

        function zoomToFarm() {
            var select = document.getElementById('farmSelect');
            var selectedOption = select.options[select.selectedIndex];
            var lat = selectedOption.getAttribute('data-lat');
            var lng = selectedOption.getAttribute('data-lng');
            if(lat && lng) {
                map.setView([lat, lng], 12);
                markers[selectedOption.value].openPopup();
                updateInfo(selectedOption.text, selectedOption.getAttribute('data-description'));
            }
        }
        function updateInfo(name, description) {
            document.getElementById('farmName').textContent = name;
            document.getElementById('farmDescription').textContent = description;
        }
    </script>
</div>
    <div class="rightSection">
        <h1 id="farmName">Farm Name</h1>
        <div class="farmInfo">
            <p id="farmDescription">Information and Metrics</p>
        </div>
    </div>
</body>
</html>
